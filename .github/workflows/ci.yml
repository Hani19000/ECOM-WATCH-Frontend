# ============================================================
# PIPELINE CI â€” INTÃ‰GRATION CONTINUE (Validation Pull Request)
# DÃ©clenchement : Ã  chaque PR vers `main` ou `develop`
# Stack : React + Vite + Tailwind v4 | HÃ©bergement : Vercel
# ============================================================

name: "CI â€” Validation Frontend"

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "**"
      - ".github/workflows/ci.yml"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1 : AUDIT DE SÃ‰CURITÃ‰
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  audit-securite:
    name: "Audit de sÃ©curitÃ© (npm audit)"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json 

      - name: "Installation des dÃ©pendances"
        run: npm ci --prefer-offline

      - name: "Scan de vulnÃ©rabilitÃ©s"
        run: npm audit --audit-level=high
        continue-on-error: true
        id: audit-result

      - name: "Archivage du rapport d'audit"
        run: npm audit --json > audit-report.json || true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: audit-rapport
          path: audit-report.json 
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2 : LINTING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  linting:
    name: "Linting ESLint"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - run: npm ci --prefer-offline

      - name: "ExÃ©cution ESLint"
        run: npm run lint

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3 : BUILD DE VALIDATION (Vite + Tailwind v4)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-validation:
    name: "Build Vite + Tailwind v4"
    runs-on: ubuntu-latest
    needs: [linting]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - run: npm ci --prefer-offline

      - name: "ðŸ”§ Injection des variables d'environnement"
        run: |
          echo "VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}" > .env
          echo "VITE_STRIPE_PUBLIC_KEY=${{ secrets.VITE_STRIPE_PUBLIC_KEY }}" >> .env
          echo "VITE_APP_BASE_URL=${{ secrets.VITE_APP_BASE_URL }}" >> .env

      - name: "npm run build"
        run: npm run build
        env:
          NODE_ENV: production

      - name: "Rapport de taille du bundle"
        run: |
          echo "=== Taille totale du dossier dist/ ==="
          du -sh dist/
          echo ""
          echo "=== Top 5 fichiers les plus lourds ==="
          find dist/assets -type f | xargs ls -lh 2>/dev/null | sort -k5 -rh | head -5

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4 : COMMENTAIRE RÃ‰SUMÃ‰ SUR LA PR
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  rapport-pr:
    name: "RÃ©sumÃ© sur la PR"
    runs-on: ubuntu-latest
    needs: [audit-securite, linting, build-validation]
    if: always() && github.event_name == 'pull_request'

    steps:
      - name: "Poster le rÃ©sumÃ©"
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = {
              audit:  '${{ needs.audit-securite.result }}',
              lint:   '${{ needs.linting.result }}',
              build:  '${{ needs.build-validation.result }}'
            };
            const icon = (s) => s === 'success' ? 'âœ…' : s === 'skipped' ? 'â­ï¸' : 'âŒ';
            const allOk = Object.values(jobs).every(s => s === 'success');

            const body = `## ðŸ” RÃ©sultats CI â€” ECOM-WATCH

            | Ã‰tape | RÃ©sultat |
            |-------|----------|
            | Audit sÃ©curitÃ© | ${icon(jobs.audit)} ${jobs.audit} |
            | Linting ESLint | ${icon(jobs.lint)} ${jobs.lint} |
            | Build Vite + Tailwind v4 | ${icon(jobs.build)} ${jobs.build} |

            **Commit :** \`${{ github.sha }}\` | **Branche :** \`${{ github.head_ref }}\`

            ${allOk
              ? '> **Tous les contrÃ´les passÃ©s. PR prÃªte Ã  Ãªtre mergÃ©e.**'
              : '> **Des contrÃ´les ont Ã©chouÃ©. Ã€ corriger avant de merger.**'}
            `;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: context.issue.number
            });
            const existing = comments.find(c => c.body.includes('RÃ©sultats CI â€” ECOM-WATCH'));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner, repo: context.repo.repo,
                comment_id: existing.id, body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo,
                issue_number: context.issue.number, body
              });
            }